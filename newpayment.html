<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment Entry</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <h2>New Payment</h2>

  <div>
    <label>Date: <span id="dateField"></span></label><br>
    <label>Shift: <span id="shiftField"></span></label><br>
    <label>User: <span id="userField"></span></label><br>
  </div>

  <div>
    <input id="nameField" placeholder="Passenger Name"><br>
    <input id="flightField" placeholder="Flight"><br>
    <input id="seatField" placeholder="Seat"><br>
    <input id="adultCountInput" placeholder="Adults" type="number"><br>
    <input id="kidCountInput" placeholder="Kids" type="number"><br>

    <select id="rateSelect">
      <option value="normal">Normal</option>
      <option value="vip">VIP</option>
    </select><br>
    <select id="currencySelect">
      <option value="MVR">MVR</option>
      <option value="USD">USD</option>
    </select><br>
    <select id="paymentTypeSelect">
      <option value="cash">Cash</option>
      <option value="card">Card</option>
    </select><br>

    <span>Rate: <span id="rateField">0</span></span><br>
    <span>GST: <span id="gstField">0</span></span><br>
    <span>Total: <span id="totalField">0</span></span><br>
    <input id="paidAmountInput" placeholder="Paid Amount" type="number"><br>
    <input id="balanceField" placeholder="Balance" readonly><br>

    <button id="saveBtn">Process Payment</button>
  </div>

  <hr>

  <div id="receiptContainer" style="display:none;">
    <h3>Receipt</h3>
    <p>Receipt No: <span id="receiptNoField"></span></p>
    <p>Date: <span id="receiptDateField"></span></p>
    <p>Shift: <span id="receiptShiftField"></span></p>
    <p>User: <span id="receiptUserField"></span></p>
    <p>Passenger: <span id="receiptPassengerField"></span></p>
    <p>Flight: <span id="receiptFlightField"></span></p>
    <p>Seat: <span id="receiptSeatField"></span></p>
    <p>Adults: <span id="receiptAdultsField"></span></p>
    <p>Kids: <span id="receiptKidsField"></span></p>
    <p>Currency: <span id="receiptCurrencyField"></span></p>
    <p>Payment Type: <span id="receiptPaymentTypeField"></span></p>
    <p>Subtotal: <span id="receiptSubtotalField"></span></p>
    <p>GST: <span id="receiptGstField"></span></p>
    <p>Total: <span id="receiptTotalField"></span></p>
    <p id="receiptPaidRow">Paid: <span id="receiptPaidField"></span></p>
    <p id="receiptBalanceRow">Balance: <span id="receiptBalanceField"></span></p>
  </div>

  <script>
    // --- Firebase Config (replace with yours) ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const paymentsRef = db.collection("payments");

    // Example logged in user
    const loggedUser = { name: "John", Level: "Cashier" };

    // Fill date, shift, user
    document.getElementById("dateField").textContent = new Date().toLocaleDateString();
    document.getElementById("shiftField").textContent = "Morning";
    document.getElementById("userField").textContent = `${loggedUser.name} (${loggedUser.Level})`;

    const saveBtn = document.getElementById("saveBtn");
    let saving = false;

    saveBtn.addEventListener("click", async () => {
      if (saving) return;
      saving = true;
      saveBtn.disabled = true;
      saveBtn.textContent = "Processing...";

      try {
        // --- Atomic transaction for safe receipt number ---
        const counterRef = db.collection("counters").doc("payments");
        let newReceiptNo = 1;

        await db.runTransaction(async (tx) => {
          const doc = await tx.get(counterRef);
          if (doc.exists) {
            newReceiptNo = (doc.data().lastNo || 0) + 1;
            tx.update(counterRef, { lastNo: newReceiptNo });
          } else {
            tx.set(counterRef, { lastNo: 1 });
            newReceiptNo = 1;
          }
        });

        // --- Collect form data ---
        const data = {
          receiptNo: newReceiptNo,
          user: loggedUser.name,
          level: loggedUser.Level,
          date: document.getElementById("dateField").textContent,
          shift: document.getElementById("shiftField").textContent,
          passenger: document.getElementById("nameField").value,
          flight: document.getElementById("flightField").value,
          seat: document.getElementById("seatField").value,
          adults: parseInt(document.getElementById("adultCountInput").value) || 0,
          kids: parseInt(document.getElementById("kidCountInput").value) || 0,
          rateType: document.getElementById("rateSelect").value,
          currency: document.getElementById("currencySelect").value,
          paymentType: document.getElementById("paymentTypeSelect").value,
          subtotal: parseFloat(document.getElementById("rateField").textContent.replace(/[^0-9.-]+/g,""))||0,
          gst: parseFloat(document.getElementById("gstField").textContent.replace(/[^0-9.-]+/g,""))||0,
          total: parseFloat(document.getElementById("totalField").textContent.replace(/[^0-9.-]+/g,""))||0,
          paid: parseFloat(document.getElementById("paidAmountInput").value)||0,
          balance: parseFloat(document.getElementById("balanceField").value.replace(/[^0-9.-]+/g,""))||0
        };

        // --- Save payment ---
        await paymentsRef.doc("receipt_" + newReceiptNo).set(data);

        // --- Build receipt ---
        const symbol = data.currency === "USD" ? "$" : "MVR ";
        document.getElementById("receiptNoField").textContent = data.receiptNo;
        document.getElementById("receiptDateField").textContent = data.date;
        document.getElementById("receiptShiftField").textContent = data.shift;
        document.getElementById("receiptUserField").textContent = `${data.user} (${data.level})`;
        document.getElementById("receiptPassengerField").textContent = data.passenger;
        document.getElementById("receiptFlightField").textContent = data.flight;
        document.getElementById("receiptSeatField").textContent = data.seat;
        document.getElementById("receiptAdultsField").textContent = data.adults;
        document.getElementById("receiptKidsField").textContent = data.kids;
        document.getElementById("receiptCurrencyField").textContent = data.currency;
        document.getElementById("receiptPaymentTypeField").textContent = data.paymentType;
        document.getElementById("receiptSubtotalField").textContent = `${symbol}${data.subtotal.toFixed(2)}`;
        document.getElementById("receiptGstField").textContent = `${symbol}${data.gst.toFixed(2)}`;
        document.getElementById("receiptTotalField").textContent = `${symbol}${data.total.toFixed(2)}`;

        if(data.paymentType.toLowerCase() === "cash"){
          document.getElementById("receiptPaidField").textContent = `${symbol}${data.paid.toFixed(2)}`;
          document.getElementById("receiptBalanceField").textContent = `${symbol}${data.balance.toFixed(2)}`;
          document.getElementById("receiptPaidRow").style.display = "block";
          document.getElementById("receiptBalanceRow").style.display = "block";
        } else {
          document.getElementById("receiptPaidRow").style.display = "none";
          document.getElementById("receiptBalanceRow").style.display = "none";
        }

        document.getElementById("receiptContainer").style.display = "block";

      } catch (err) {
        console.error("Error saving payment:", err);
        alert("Error saving payment. Try again.");
      } finally {
        saving = false;
        saveBtn.disabled = false;
        saveBtn.textContent = "Process Payment";
      }
    });
  </script>
</body>
</html>
