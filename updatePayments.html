<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payments Update & Receipt Print</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9; }
    h2 { text-align: center; margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 10px; text-align: center; }
    th { background: #333; color: #fff; }
    select, input { padding: 5px; }
    button { padding: 5px 10px; cursor: pointer; }
    .status-badge { padding: 5px 8px; border-radius: 6px; color: #fff; font-size: 12px; }
    .status-pending { background: orange; }
    .status-complete { background: green; }
    .notification {
      position: fixed;
      top: 20px; right: 20px;
      background: #333; color: #fff;
      padding: 10px 15px; border-radius: 6px;
      display: none; z-index: 999;
    }
    .notification.success { background: green; }
    .notification.error { background: red; }

    /* Receipt Modal */
    .modal {
      display: none; position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 1000;
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 20px;
      border-radius: 8px; width: 400px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; }
    .close-modal { cursor: pointer; font-size: 20px; }
    .receipt { font-family: monospace; margin-top: 10px; }
    .receipt h4 { margin-bottom: 10px; text-align: center; }
    .receipt p { margin: 4px 0; }
    .top-controls { text-align: right; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Payments Requiring Update</h2>

  <div class="top-controls">
    <button onclick="printAllReceipts()">🖨 Print All Pending Receipts</button>
  </div>

  <table id="paymentsTable">
    <thead>
      <tr>
        <th>Receipt No</th>
        <th>Name</th>
        <th>Flight</th>
        <th>Payment Type</th>
        <th>Batch No</th>
        <th>Approval Code</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Voided Payments (Audit)</h2>
  <table id="voidedTable">
    <thead>
      <tr>
        <th>Receipt No</th>
        <th>Name</th>
        <th>Flight</th>
        <th>Payment Type</th>
        <th>Total</th>
        <th>Date</th>
        <th>Reason</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="notification" class="notification"></div>

  <!-- Receipt Modal -->
  <div class="modal" id="receiptModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Receipt</h3>
        <span class="close-modal" onclick="closeReceiptModal()">&times;</span>
      </div>
      <div id="receiptDetails" class="receipt"></div>
      <button onclick="printReceipt()">🖨 Print</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="fire2.js"></script>

  <script>
    const paymentsTable = document.getElementById("paymentsTable").querySelector("tbody");
    const voidedTable = document.getElementById("voidedTable").querySelector("tbody");
    const notification = document.getElementById("notification");
    const receiptModal = document.getElementById("receiptModal");
    const receiptDetails = document.getElementById("receiptDetails");

    let pendingPayments = [];

    function showNotification(message, type="success") {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = "block";
      setTimeout(() => { notification.style.display = "none"; }, 3000);
    }

    function openReceiptModal(data) {
      receiptDetails.innerHTML = `
        <h4>Booking Receipt</h4>
        <p><b>Receipt No:</b> ${data.receiptNo || ''}</p>
        <p><b>Date:</b> ${data.date || ''}</p>
        <p><b>Name:</b> ${data.name || ''}</p>
        <p><b>Flight:</b> ${data.flight || ''}</p>
        <p><b>Seat:</b> ${data.seat || ''}</p>
        <p><b>Adults:</b> ${data.adults || 0}</p>
        <p><b>Kids:</b> ${data.kids || 0}</p>
        <p><b>Total:</b> ${data.total || '0.00'} ${data.currency || ''}</p>
        <p><b>Payment:</b> ${data.paymentType || ''}</p>
        <p><b>Batch No:</b> ${data.batchNo || '-'}</p>
        <p><b>Approval Code:</b> ${data.approvalCode || '-'}</p>
      `;
      receiptModal.style.display = "flex";
    }

    function closeReceiptModal() {
      receiptModal.style.display = "none";
    }

    function printReceipt() {
      const printWin = window.open("", "", "width=400,height=600");
      printWin.document.write("<pre>" + receiptDetails.innerHTML + "</pre>");
      printWin.document.close();
      printWin.print();
    }

    function printAllReceipts() {
      if (pendingPayments.length === 0) { alert("No pending receipts to print."); return; }
      let content = "<h2>Pending Receipts</h2>";
      pendingPayments.forEach(d => {
        content += `
          <h4>Booking Receipt</h4>
          <p><b>Receipt No:</b> ${d.receiptNo || ''}</p>
          <p><b>Date:</b> ${d.date || ''}</p>
          <p><b>Name:</b> ${d.name || ''}</p>
          <p><b>Flight:</b> ${d.flight || ''}</p>
          <p><b>Seat:</b> ${d.seat || ''}</p>
          <p><b>Adults:</b> ${d.adults || 0}</p>
          <p><b>Kids:</b> ${d.kids || 0}</p>
          <p><b>Total:</b> ${d.total || '0.00'} ${d.currency || ''}</p>
          <p><b>Payment:</b> ${d.paymentType || ''}</p>
          <p><b>Batch No:</b> ${d.batchNo || '-'}</p>
          <p><b>Approval Code:</b> ${d.approvalCode || '-'}</p>
          <hr/>
        `;
      });
      const printWin = window.open("", "", "width=500,height=700");
      printWin.document.write("<pre>" + content + "</pre>");
      printWin.document.close();
      printWin.print();
    }

    function loadPayments() {
      db.collection("payments").onSnapshot(snapshot => {
        paymentsTable.innerHTML = "";
        voidedTable.innerHTML = "";
        pendingPayments = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          const id = doc.id;

          // ✅ Voided payments
          if (data.voided === true) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${data.receiptNo || ''}</td>
              <td>${data.name || ''}</td>
              <td>${data.flight || ''}</td>
              <td>${data.paymentType || ''}</td>
              <td>${data.total || ''}</td>
              <td>${data.date || ''}</td>
              <td>${data.voidReason || '-'}</td>
            `;
            voidedTable.appendChild(row);
            return;
          }

          // Non-cash pending payments
          if (data.paymentType !== "Cash" && (!data.batchNo || !data.approvalCode)) {
            pendingPayments.push(data);

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${data.receiptNo || ""}</td>
              <td>${data.name || ""}</td>
              <td>${data.flight || ""}</td>
              <td>
                <select class="payType">
                  <option value="Card" ${data.paymentType==="Card"?"selected":""}>Card</option>
                  <option value="Visa" ${data.paymentType==="Visa"?"selected":""}>Visa</option>
                  <option value="MasterCard" ${data.paymentType==="MasterCard"?"selected":""}>MasterCard</option>
                  <option value="Cash" ${data.paymentType==="Cash"?"selected":""}>Cash</option>
                </select>
              </td>
              <td><input type="text" class="batchNo" value="${data.batchNo||""}"></td>
              <td><input type="text" class="approvalCode" value="${data.approvalCode||""}"></td>
              <td>
                <span class="status-badge ${data.status==="complete"?"status-complete":"status-pending"}">
                  ${data.status || "Pending"}
                </span>
              </td>
              <td>
                <button class="btn-update">Update</button>
                <button class="btn-print">Print</button>
              </td>
            `;

            row.querySelector(".btn-update").addEventListener("click", async () => {
              const newPayType = row.querySelector(".payType").value;
              const batchNo = row.querySelector(".batchNo").value.trim();
              const approvalCode = row.querySelector(".approvalCode").value.trim();

              if (newPayType==="Cash" && (batchNo || approvalCode)) {
                alert("Cash payments must not have Batch No or Approval Code."); return;
              }
              if (newPayType!=="Cash" && (!batchNo || !approvalCode)) {
                alert("Non-cash payments require Batch No and Approval Code."); return;
              }

              try {
                await db.collection("payments").doc(id).update({
                  paymentType: newPayType,
                  batchNo: newPayType==="Cash"?null:batchNo,
                  approvalCode: newPayType==="Cash"?null:approvalCode,
                  status: "complete",
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const statusBadge = row.querySelector(".status-badge");
                statusBadge.textContent = "Complete";
                statusBadge.className = "status-badge status-complete";

                showNotification("✅ Payment updated successfully!", "success");
              } catch (err) {
                showNotification("❌ Error updating payment: "+err.message, "error");
              }
            });

            row.querySelector(".btn-print").addEventListener("click", () => openReceiptModal(data));

            paymentsTable.appendChild(row);
          }
        });
      });
    }

    loadPayments();
    window.onclick = e => { if (e.target === receiptModal) closeReceiptModal(); }
  </script>
</body>
</html>
