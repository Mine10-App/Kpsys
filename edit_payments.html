<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment Management System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* your same styles (unchanged) */
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2><i class="fas fa-calendar-check"></i> Payment Management System</h2>
    <p>View, edit, and manage all Payment receipts in one place</p>
  </div>

  <div class="controls">
    <div class="search-container">
      <label for="searchReceipt">Search Payments:</label>
      <i class="fas fa-search search-icon"></i>
      <input type="number" id="searchReceipt" placeholder="Enter Receipt Number">
      <button id="searchBtn" class="btn">
        <i class="fas fa-search"></i> Search
      </button>
    </div>
    <div>
      <button id="loadAllBtn" class="btn btn-success">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </div>

  <div class="bookings-container">
    <div class="bookings-header">
      <div class="bookings-header-left">
        <i class="fas fa-list"></i>
        <span>Payments List</span>
      </div>
      <div class="filter-controls">
        <button class="filter-btn active">All</button>
      </div>
    </div>
    <div class="bookings-content">
      <div id="bookingsDiv">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading payments...</p>
        </div>
      </div>
      <div class="pagination">
        <button class="pagination-btn"><i class="fas fa-chevron-left"></i></button>
        <button class="pagination-btn active">1</button>
        <button class="pagination-btn">2</button>
        <button class="pagination-btn">3</button>
        <button class="pagination-btn"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="viewModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-receipt"></i> Payment Details</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <p>Payment details will load here...</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-warning"><i class="fas fa-print"></i> Print</button>
      <button class="btn btn-edit"><i class="fas fa-edit"></i> Edit</button>
      <button class="btn" style="background: var(--gray);">Close</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// âœ… Firestore Initialization
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXXXX",
  appId: "XXXXXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Elements
const bookingsDiv = document.getElementById("bookingsDiv");
const searchReceipt = document.getElementById("searchReceipt");
const searchBtn = document.getElementById("searchBtn");
const loadAllBtn = document.getElementById("loadAllBtn");
const viewModal = document.getElementById("viewModal");
const closeModal = document.querySelector(".close-modal");

// Fetch and display payments
async function loadBookings(query = null) {
  bookingsDiv.innerHTML = `
    <div class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading payments...</p>
    </div>
  `;

  let snapshot;
  try {
    if(query){
      snapshot = await db.collection("payments")
                         .where("receiptNo", "==", parseInt(query))
                         .get();
    } else {
      snapshot = await db.collection("payments")
                         .orderBy("timestamp", "desc")
                         .get();
    }

    if(snapshot.empty){
      bookingsDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-receipt"></i>
          <p>No payments found.</p>
          <button class="btn" onclick="loadBookings()"><i class="fas fa-sync"></i> Try Again</button>
        </div>
      `;
      return;
    }

    let html = `<table>
      <thead>
        <tr>
          <th>Receipt No <i class="fas fa-sort"></i></th>
          <th>Date</th>
          <th>Name</th>
          <th>Flight</th>
          <th>Seat</th>
          <th>Adults</th>
          <th>Kids</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>`;

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const voidedClass = data.voided ? "voided-row" : "";
      const statusClass = data.voided ? "status-voided" : "status-active";
      const statusText = data.voided ? "VOID" : "Active";
      
      html += `
      <tr class="${voidedClass}">
        <td>${data.receiptNo}</td>
        <td>${data.date || '-'}</td>
        <td>${data.name || '-'}</td>
        <td>${data.flight || '-'}</td>
        <td>${data.seat || '-'}</td>
        <td>${data.adults || '0'}</td>
        <td>${data.kids || '0'}</td>
        <td>${data.total ? data.total.toFixed(2) : '0.00'} ${data.currency || ''}</td>
        <td>${data.paymentType || '-'}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td>
          <div class="action-buttons">
            <button onclick="viewBooking('${doc.id}')" class="action-btn btn-view">
              <i class="fas fa-eye"></i> View
            </button>
            <button onclick="editBooking('${doc.id}')" class="action-btn btn-edit">
              <i class="fas fa-edit"></i> Edit
            </button>
            ${!data.voided ? `
            <button onclick="voidBooking('${doc.id}')" class="action-btn btn-void">
              <i class="fas fa-ban"></i> Void
            </button>
            ` : ''}
          </div>
        </td>
      </tr>`;
    });

    html += `</tbody></table>`;
    bookingsDiv.innerHTML = html;
  } catch(err){
    console.error(err);
    bookingsDiv.innerHTML = `
      <div style="color: #e74c3c; text-align: center; padding: 20px;">
        <i class="fas fa-exclamation-circle"></i>
        <p>Error loading payments: ${err.message}</p>
      </div>
    `;
  }
}

// View payment
function viewBooking(docId) {
  viewModal.style.display = "flex";
}

// Edit payment
async function editBooking(docId){
  try {
    const docRef = db.collection("payments").doc(docId);
    const docSnap = await docRef.get();
    if(!docSnap.exists){ 
      alert("Payment not found!"); 
      return; 
    }
    const data = docSnap.data();

    const newName = prompt("Name:", data.name || '');
    if(newName === null) return;

    const newFlight = prompt("Flight:", data.flight || '');
    if(newFlight === null) return;

    const newSeat = prompt("Seat:", data.seat || '');
    if(newSeat === null) return;

    const newAdults = prompt("Adults:", data.adults || '0');
    if(newAdults === null) return;

    const newKids = prompt("Kids:", data.kids || '0');
    if(newKids === null) return;

    const newPayment = prompt("Payment Type (Cash/Card):", data.paymentType || '');
    if(newPayment === null) return;

    await docRef.update({
      name: newName,
      flight: newFlight,
      seat: newSeat,
      adults: parseInt(newAdults),
      kids: parseInt(newKids),
      paymentType: newPayment
    });

    alert("Payment updated successfully!");
    loadBookings();

  } catch(err){
    console.error("Update failed:", err);
    alert("Error updating payment: " + err.message);
  }
}

// Void payment
async function voidBooking(docId){
  const reason = prompt("Enter reason for voiding this payment:");
  if(!reason) return;
  try{
    await db.collection("payments").doc(docId).update({
      voided: true,
      voidReason: reason
    });
    alert("Payment voided successfully!");
    loadBookings();
  } catch(err){
    alert("Error voiding payment: " + err.message);
  }
}

// Events
searchBtn.addEventListener("click", () => {
  if (searchReceipt.value) {
    loadBookings(searchReceipt.value);
  } else {
    alert("Please enter a receipt number to search");
  }
});
loadAllBtn.addEventListener("click", () => {
  searchReceipt.value = "";
  loadBookings();
});
closeModal.addEventListener("click", () => {
  viewModal.style.display = "none";
});
window.addEventListener("click", (e) => {
  if (e.target === viewModal) {
    viewModal.style.display = "none";
  }
});
window.addEventListener("DOMContentLoaded", () => loadBookings());
</script>
</body>
</html>
