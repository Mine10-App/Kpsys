<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash & Petty Cash Management</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="fire2.js"></script>
    <script src="user.js"></script>
    <!-- Include a hashing library for password verification -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
    :root {
        --primary: #8c6d1f;
        --primary-light: #a6852d;
        --secondary: #d4af37;
        --accent: #c19a1b;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #e74c3c;
        --light: #ffffff;
        --dark: #5d4d0f;
        --gray: #8a7c4a;
        --border: #e0d6b3;
        --shadow: 0 4px 6px rgba(140, 109, 31, 0.1);
        --radius: 8px;
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--dark);
        background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
        min-height: 100vh;
        padding: 20px;
        overflow-x: auto;
    }
    
    .container {
        max-width: 1500px;
        margin: 0 auto;
        min-width: 1300px;
    }
    
    header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    
    h1 {
        color: var(--primary);
        margin-bottom: 10px;
        font-size: 2.2rem;
    }
    
    h2 {
        color: var(--primary);
        margin-bottom: 15px;
        font-size: 1.5rem;
        border-bottom: 2px solid var(--secondary);
        padding-bottom: 8px;
    }
    
    h3 {
        color: var(--primary-light);
        margin-bottom: 10px;
        font-size: 1.1rem;
        text-align: center;
    }
    
    /* Cash Payments and Petty Cash in one row */
    .info-cards-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        flex: 1;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid var(--border);
    }
    
    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(212, 175, 55, 0.15);
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 10px;
    }
    
    .info-item {
        background: #fefcf5;
        border-radius: var(--radius);
        padding: 15px;
        text-align: center;
        border: 1px solid var(--border);
    }
    
    .info-label {
        font-weight: 600;
        color: var(--gray);
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .info-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--dark);
    }
    
    /* All tables in one row - more compact */
    .all-tables-row {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .table-section {
        background: white;
        border-radius: var(--radius);
        padding: 12px;
        box-shadow: var(--shadow);
        min-width: 220px;
        flex: 1;
        border: 1px solid var(--border);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
    }
    
    th, td {
        padding: 6px 4px;
        text-align: center;
        border-bottom: 1px solid var(--border);
        font-size: 0.8rem;
    }
    
    th {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        font-weight: 600;
        padding: 8px 4px;
    }
    
    tr:nth-child(even) {
        background-color: #fefcf5;
    }
    
    input[type="number"] {
        width: 50px;
        padding: 4px;
        border: 1px solid var(--border);
        border-radius: 4px;
        text-align: center;
        font-weight: 600;
        font-size: 0.8rem;
        transition: border 0.3s ease;
        background-color: white;
    }
    
    input[type="number"]:focus {
        border-color: var(--secondary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    
    .total-row {
        background-color: #fef8e7;
        font-weight: bold;
    }
    
    .total-row td {
        border-top: 2px solid var(--border);
        font-size: 0.85rem;
        color: var(--primary);
        padding: 8px 4px;
    }
    
    .summary {
        background: white;
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: var(--shadow);
        margin-top: 20px;
        border: 1px solid var(--border);
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed var(--border);
    }
    
    .summary-label {
        font-weight: 600;
        color: var(--gray);
        font-size: 0.9rem;
    }
    
    .summary-value {
        font-weight: 700;
        color: var(--dark);
        font-size: 0.9rem;
    }
    
    .extra-cash {
        color: var(--success);
        font-weight: bold;
    }
    
    .short-cash {
        color: var(--danger);
        font-weight: bold;
    }
    
    .grand-total {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid var(--secondary);
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
    }
    
    .buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }
    
    button {
        padding: 10px 25px;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    button:disabled {
        background: var(--gray) !important;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .open-btn {
        background: var(--success);
        color: white;
    }
    
    .open-btn:hover:not(:disabled) {
        background: #219653;
        transform: translateY(-2px);
    }
    
    .close-btn {
        background: var(--primary);
        color: white;
    }
    
    .close-btn:hover:not(:disabled) {
        background: var(--accent);
        transform: translateY(-2px);
    }
    
    /* Popup */
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .popup-content {
        background: white;
        padding: 25px;
        border-radius: var(--radius);
        width: 90%;
        max-width: 350px;
        box-shadow: 0 10px 25px rgba(140, 109, 31, 0.15);
        border: 2px solid var(--secondary);
    }
    
    .popup-content h3 {
        margin-bottom: 15px;
        text-align: center;
        color: var(--primary);
        font-size: 1.2rem;
    }
    
    .popup-content input {
        width: 100%;
        margin-bottom: 12px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.9rem;
        background-color: white;
    }
    
    .popup-content input:focus {
        border-color: var(--secondary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    
    .popup-content button {
        width: 100%;
        padding: 10px;
        background: var(--primary);
        color: white;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    
    .popup-content button:hover {
        background: var(--accent);
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
    }
    
    .status-active {
        background-color: var(--success);
    }
    
    .status-inactive {
        background-color: var(--accent);
    }
    
    .error-message {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 10px;
        text-align: center;
        display: none;
    }
    
    .loading {
        display: none;
        text-align: center;
        color: var(--primary);
        margin: 10px 0;
    }
    
    @media (max-width: 1300px) {
        body {
            overflow-x: auto;
        }
        
        .container {
            min-width: 1200px;
        }
        
        .all-tables-row {
            gap: 10px;
        }
        
        .table-section {
            min-width: 200px;
        }
    }
    
    @media (max-width: 768px) {
        body {
            padding: 10px;
            overflow-x: auto;
        }
        
        .container {
            min-width: 1100px;
        }
        
        .info-cards-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .all-tables-row {
            gap: 8px;
        }
        
        .table-section {
            min-width: 190px;
        }
        
        .buttons {
            flex-direction: column;
            align-items: center;
        }
        
        button {
            width: 100%;
            max-width: 280px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cash & Petty Cash Management</h1>
            <p>Professional cash reconciliation system</p>
        </header>
        
        <section class="info-cards-row">
            <div class="info-card">
                <h2>Shift & Date Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Current Date</div>
                        <div class="info-value" id="currentDate">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cashier Status</div>
                        <div class="info-value">
                            <span class="status-indicator" id="statusIndicator"></span>
                            <span id="cashierStatus">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h2>Cash Payments from Firebase</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Total USD Cash</div>
                        <div class="info-value" id="totalUSD">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total MVR Cash</div>
                        <div class="info-value" id="totalMVR">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h2>Petty Cash</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">USD Petty Cash</div>
                        <div class="info-value" id="pettyUSD">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">MVR Petty Cash</div>
                        <div class="info-value" id="pettyMVR">Loading...</div>
                    </div>
                </div>
            </div>
        </section>
        
        <section>
            <h2>All Denomination Counts</h2>
            <div class="all-tables-row">
                <div class="table-section">
                    <h3>Sales USD Count</h3>
                    <table id="usdTable">
                        <thead>
                            <tr>
                                <th>USD</th>
                                <th>Count</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="2">Total</td>
                                <td id="usdGrandTotal">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="table-section">
                    <h3>Sales MVR Count</h3>
                    <table id="mvrTable">
                        <thead>
                            <tr>
                                <th>MVR</th>
                                <th>Count</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="2">Total</td>
                                <td id="mvrGrandTotal">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="table-section">
                    <h3>USD Petty Cash</h3>
                    <table id="pettyUSDTable">
                        <thead>
                            <tr>
                                <th>USD</th>
                                <th>Count</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="2">Total</td>
                                <td id="pettyUSDGrandTotal">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="table-section">
                    <h3>MVR Petty Cash</h3>
                    <table id="pettyMVRTable">
                        <thead>
                            <tr>
                                <th>MVR</th>
                                <th>Count</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="2">Total</td>
                                <td id="pettyMVRGrandTotal">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>
        
        <section class="summary">
            <h2>Reconciliation Summary</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Sales USD (Actual):</span>
                    <span class="summary-value" id="actualSalesUSD">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Sales USD (Counted):</span>
                    <span class="summary-value" id="countedSalesUSD">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Sales USD (Difference):</span>
                    <span class="summary-value" id="differenceSalesUSD">0.00</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Sales MVR (Actual):</span>
                    <span class="summary-value" id="actualSalesMVR">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Sales MVR (Counted):</span>
                    <span class="summary-value" id="countedSalesMVR">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Sales MVR (Difference):</span>
                    <span class="summary-value" id="differenceSalesMVR">0.00</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Petty USD (Actual):</span>
                    <span class="summary-value" id="actualPettyUSD">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Petty USD (Counted):</span>
                    <span class="summary-value" id="countedPettyUSD">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Petty USD (Difference):</span>
                    <span class="summary-value" id="differencePettyUSD">0.00</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Petty MVR (Actual):</span>
                    <span class="summary-value" id="actualPettyMVR">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Petty MVR (Counted):</span>
                    <span class="summary-value" id="countedPettyMVR">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Petty MVR (Difference):</span>
                    <span class="summary-value" id="differencePettyMVR">0.00</span>
                </div>
            </div>
            
            <div class="grand-total">
                <span>Total Extra Cash USD:</span>
                <span id="totalExtraUSD">0.00</span>
            </div>
            <div class="grand-total">
                <span>Total Extra Cash MVR:</span>
                <span id="totalExtraMVR">0.00</span>
            </div>
        </section>
        
        <div class="buttons">
            <button id="openShiftBtn" class="open-btn" disabled>
                <span>Open Cashier</span>
            </button>
            <button id="closeShiftBtn" class="close-btn" disabled>
                <span>Close Cashier</span>
            </button>
        </div>
    </div>

    <!-- Popup for username/password -->
    <div id="authPopup" class="popup">
        <div class="popup-content">
            <h3>Enter Username & Password</h3>
            <input type="text" id="popupUsername" placeholder="Username">
            <input type="password" id="popupPassword" placeholder="Password">
            <div class="loading" id="loading">Verifying credentials...</div>
            <div class="error-message" id="errorMessage">Invalid credentials</div>
            <button id="popupSubmit">Submit</button>
        </div>
    </div>

    <script>
        // Denominations
        const usdDenoms = [100,50,20,10,5,1];
        const mvrDenoms = [1000,500,100,50,20,5,1];

        // Firebase elements
        const totalUSDEl = document.getElementById("totalUSD");
        const totalMVREl = document.getElementById("totalMVR");
        const pettyUSDEl = document.getElementById("pettyUSD");
        const pettyMVREl = document.getElementById("pettyMVR");
        const statusIndicator = document.getElementById("statusIndicator");
        const cashierStatus = document.getElementById("cashierStatus");
        const errorMessage = document.getElementById("errorMessage");
        const loading = document.getElementById("loading");

        const openBtn = document.getElementById("openShiftBtn");
        const closeBtn = document.getElementById("closeShiftBtn");

        // Current date
        const today = new Date();
        document.getElementById("currentDate").textContent = today.toISOString().split('T')[0];

        // Create denomination tables
        function createDenominationTable(denoms, tbodySelector, grandTotalSelector){
            const tbody = document.querySelector(tbodySelector);
            const grandEl = document.querySelector(grandTotalSelector);
            
            function updateGrandTotal(){
                let total=0;
                document.querySelectorAll(`${tbodySelector} .row-total`).forEach(c=>{total+=Number(c.textContent)});
                grandEl.textContent = total.toFixed(2);
                updateSummary();
            }
            
            denoms.forEach(v=>{
                const row = document.createElement("tr");
                const tdDenom = document.createElement("td"); 
                tdDenom.textContent = v; 
                row.appendChild(tdDenom);
                
                const tdCount = document.createElement("td"); 
                const input = document.createElement("input"); 
                input.type="number"; 
                input.min=0; 
                input.value=0; 
                tdCount.appendChild(input); 
                row.appendChild(tdCount);
                
                const tdTotal = document.createElement("td"); 
                tdTotal.classList.add("row-total"); 
                tdTotal.textContent="0.00"; 
                row.appendChild(tdTotal);
                
                input.addEventListener("input",()=>{
                    tdTotal.textContent=((Number(input.value)||0)*v).toFixed(2); 
                    updateGrandTotal();
                });
                
                tbody.appendChild(row);
            });
        }

        createDenominationTable(usdDenoms,"#usdTable tbody","#usdGrandTotal");
        createDenominationTable(mvrDenoms,"#mvrTable tbody","#mvrGrandTotal");
        createDenominationTable(usdDenoms,"#pettyUSDTable tbody","#pettyUSDGrandTotal");
        createDenominationTable(mvrDenoms,"#pettyMVRTable tbody","#pettyMVRGrandTotal");

        // Fetch totals from Firebase
        function fetchCashTotals(){
            // Fetch USD cash payments
            db.collection("payments")
                .where("date", "==", document.getElementById("currentDate").textContent)
                .where("paymentType", "==", "Cash")
                .where("currency", "==", "USD")
                .onSnapshot(snap => {
                    let total = 0; 
                    snap.forEach(doc => {
                        const payment = doc.data(); 
                        if(!payment.voided) total += Number(payment.total || 0);
                    }); 
                    totalUSDEl.textContent = total.toFixed(2); 
                    updateSummary();
                });
            
            // Fetch MVR cash payments
            db.collection("payments")
                .where("date", "==", document.getElementById("currentDate").textContent)
                .where("paymentType", "==", "Cash")
                .where("currency", "==", "MVR")
                .onSnapshot(snap => {
                    let total = 0; 
                    snap.forEach(doc => {
                        const payment = doc.data(); 
                        if(!payment.voided) total += Number(payment.total || 0);
                    }); 
                    totalMVREl.textContent = total.toFixed(2); 
                    updateSummary();
                });
            
            // Fetch petty cash
            db.collection("pettyCash").limit(1).onSnapshot(snap => {
                if(!snap.empty){
                    const data = snap.docs[0].data();
                    pettyUSDEl.textContent = Number(data.USD || 0).toFixed(2);
                    pettyMVREl.textContent = Number(data.MVR || 0).toFixed(2);
                    updateSummary();
                }
            });
        }
        
        // Initialize Firebase and fetch data
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to initialize
            setTimeout(() => {
                if (typeof db !== 'undefined') {
                    fetchCashTotals();
                    checkCashierStatus();
                } else {
                    console.error("Firebase not initialized. Check your fire2.js configuration.");
                }
            }, 1000);
        });

        // Update summary with proper calculations
        function updateSummary(){
            // Get actual values from Firebase
            const actualSalesUSD = Number(totalUSDEl.textContent);
            const actualSalesMVR = Number(totalMVREl.textContent);
            const actualPettyUSD = Number(pettyUSDEl.textContent);
            const actualPettyMVR = Number(pettyMVREl.textContent);
            
            // Get counted values from denomination tables
            const countedSalesUSD = Number(document.getElementById("usdGrandTotal").textContent);
            const countedSalesMVR = Number(document.getElementById("mvrGrandTotal").textContent);
            const countedPettyUSD = Number(document.getElementById("pettyUSDGrandTotal").textContent);
            const countedPettyMVR = Number(document.getElementById("pettyMVRGrandTotal").textContent);
            
            // Calculate differences (positive = extra cash, negative = short cash)
            const differenceSalesUSD = countedSalesUSD - actualSalesUSD;
            const differenceSalesMVR = countedSalesMVR - actualSalesMVR;
            const differencePettyUSD = countedPettyUSD - actualPettyUSD;
            const differencePettyMVR = countedPettyMVR - actualPettyMVR;
            
            // Calculate total extra cash (only positive differences)
            const totalExtraUSD = Math.max(0, differenceSalesUSD) + Math.max(0, differencePettyUSD);
            const totalExtraMVR = Math.max(0, differenceSalesMVR) + Math.max(0, differencePettyMVR);
            
            // Update summary display
            document.getElementById("actualSalesUSD").textContent = actualSalesUSD.toFixed(2);
            document.getElementById("actualSalesMVR").textContent = actualSalesMVR.toFixed(2);
            document.getElementById("actualPettyUSD").textContent = actualPettyUSD.toFixed(2);
            document.getElementById("actualPettyMVR").textContent = actualPettyMVR.toFixed(2);
            
            document.getElementById("countedSalesUSD").textContent = countedSalesUSD.toFixed(2);
            document.getElementById("countedSalesMVR").textContent = countedSalesMVR.toFixed(2);
            document.getElementById("countedPettyUSD").textContent = countedPettyUSD.toFixed(2);
            document.getElementById("countedPettyMVR").textContent = countedPettyMVR.toFixed(2);
            
            // Update differences with color coding
            updateDifferenceDisplay("differenceSalesUSD", differenceSalesUSD);
            updateDifferenceDisplay("differenceSalesMVR", differenceSalesMVR);
            updateDifferenceDisplay("differencePettyUSD", differencePettyUSD);
            updateDifferenceDisplay("differencePettyMVR", differencePettyMVR);
            
            document.getElementById("totalExtraUSD").textContent = totalExtraUSD.toFixed(2);
            document.getElementById("totalExtraMVR").textContent = totalExtraMVR.toFixed(2);
            
            checkButtonStatus(countedSalesUSD, countedSalesMVR, countedPettyUSD, countedPettyMVR, 
                            actualSalesUSD, actualSalesMVR, actualPettyUSD, actualPettyMVR);
        }

        // Update difference display with color coding
        function updateDifferenceDisplay(elementId, difference) {
            const element = document.getElementById(elementId);
            element.textContent = difference.toFixed(2);
            
            if (difference > 0) {
                element.className = "summary-value extra-cash";
            } else if (difference < 0) {
                element.className = "summary-value short-cash";
            } else {
                element.className = "summary-value";
            }
        }

        // Cashier status management
        let activeCashierData = null;

        // Listen for active cashier
        function checkCashierStatus() {
            db.collection("cashier")
                .where("active", "==", true)
                .limit(1)
                .onSnapshot(snap => {
                    if (snap.empty) {
                        activeCashierData = null;
                        statusIndicator.className = "status-indicator status-inactive";
                        cashierStatus.textContent = "Inactive";
                        updateButtonVisibility(null);
                    } else {
                        activeCashierData = snap.docs[0].data();
                        activeCashierData.id = snap.docs[0].id;
                        statusIndicator.className = "status-indicator status-active";
                        cashierStatus.textContent = `Active - ${activeCashierData.currentCashier}`;
                        updateButtonVisibility(activeCashierData.currentCashier);
                    }
                    updateSummary();
                });
        }

        // Enable/disable buttons based on counts and active cashier
        function checkButtonStatus(countedUSD, countedMVR, countedPettyUSD, countedPettyMVR, 
                                 actualUSD, actualMVR, actualPettyUSD, actualPettyMVR) {
            // Check if counts are valid (counted amount >= actual amount)
            const salesCountsValid = countedUSD >= actualUSD && countedMVR >= actualMVR;
            const pettyCountsValid = countedPettyUSD >= actualPettyUSD && countedPettyMVR >= actualPettyMVR;
            
            // Both sales and petty cash counts should be valid
            const countsValid = salesCountsValid && pettyCountsValid;

            if (!countsValid) {
                openBtn.disabled = true;
                closeBtn.disabled = true;
                return;
            }

            // If counts are valid, update button visibility
            updateButtonVisibility(activeCashierData ? activeCashierData.currentCashier : null);
        }

        // Update button visibility based on cashier status and current user
        function updateButtonVisibility(currentCashier) {
            const currentUser = getCurrentUser();
            
            if (!currentCashier) {
                // No active cashier - anyone can open
                openBtn.disabled = false;
                closeBtn.disabled = true;
            } else {
                // Active cashier exists
                openBtn.disabled = true;
                
                // Only enable close button if current user is the one who opened it
                if (currentUser === currentCashier) {
                    closeBtn.disabled = false;
                } else {
                    closeBtn.disabled = true;
                    closeBtn.title = `Only ${currentCashier} can close this cashier`;
                }
            }
        }

        // Get current user
        function getCurrentUser() {
            return localStorage.getItem('currentUser');
        }

        // Verify hashed password
        function verifyPassword(inputPassword, storedHash) {
            // Hash the input password using SHA-256
            const inputHash = sha256(inputPassword);
            return inputHash === storedHash;
        }

        // Authenticate user with hashed password
        function authenticateUser(username, password) {
            return new Promise((resolve, reject) => {
                try {
                    if (typeof users === 'undefined') {
                        reject(new Error('User database not found. Please check user.js'));
                        return;
                    }

                    // Debug: log available users
                    console.log('Available users:', users);

                    const user = users.find(u => u.username === username);
                    
                    if (!user) {
                        reject(new Error('User not found'));
                        return;
                    }

                    // Check if password field exists
                    if (!user.password) {
                        reject(new Error('User password hash not found'));
                        return;
                    }

                    // Verify the hashed password
                    if (verifyPassword(password, user.password)) {
                        resolve(user);
                    } else {
                        reject(new Error('Invalid password'));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Popup logic
        let actionType = null; // "open" or "close"
        function showAuthPopup(type) { 
            actionType = type; 
            document.getElementById("authPopup").style.display = "flex"; 
            document.getElementById("popupUsername").value = "";
            document.getElementById("popupPassword").value = "";
            errorMessage.style.display = "none";
            loading.style.display = "none";
            document.getElementById("popupUsername").focus();
        }

        function hideAuthPopup() { 
            document.getElementById("authPopup").style.display = "none"; 
        }

        // Button events
        openBtn.addEventListener("click", () => showAuthPopup("open"));
        closeBtn.addEventListener("click", () => showAuthPopup("close"));

        document.getElementById("popupSubmit").addEventListener("click", async () => {
            const username = document.getElementById("popupUsername").value;
            const password = document.getElementById("popupPassword").value;

            if (!username || !password) {
                errorMessage.textContent = "Please enter both username and password";
                errorMessage.style.display = "block";
                return;
            }

            // Show loading
            loading.style.display = "block";
            errorMessage.style.display = "none";
            document.getElementById("popupSubmit").disabled = true;

            try {
                const user = await authenticateUser(username, password);
                
                // Clear messages and enable button
                loading.style.display = "none";
                errorMessage.style.display = "none";
                document.getElementById("popupSubmit").disabled = false;

                // Authentication successful
                if (actionType === "open") {
                    if (activeCashierData) {
                        alert(`Cashier already active (opened by ${activeCashierData.currentCashier})`);
                        hideAuthPopup();
                        return;
                    }
                    
                    // Store current user in localStorage
                    localStorage.setItem('currentUser', username);
                    
                    // Create new cashier session
                    db.collection("cashier").add({
                        currentCashier: username,
                        active: true,
                        openedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        date: document.getElementById("currentDate").textContent
                    }).then(() => {
                        alert("Cashier opened successfully"); 
                        hideAuthPopup();
                    }).catch(error => {
                        alert("Error opening cashier: " + error.message);
                    });
                    
                } else if (actionType === "close") {
                    if (!activeCashierData) {
                        alert("No active cashier");
                        hideAuthPopup();
                        return;
                    }
                    
                    // Check if the user trying to close is the one who opened it
                    if (username !== activeCashierData.currentCashier) {
                        alert(`Only ${activeCashierData.currentCashier} can close this cashier`);
                        hideAuthPopup();
                        return;
                    }
                    
                    // Close the cashier
                    db.collection("cashier").doc(activeCashierData.id).update({
                        active: false,
                        closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        closedBy: username
                    }).then(() => {
                        // Clear current user from localStorage
                        localStorage.removeItem('currentUser');
                        alert("Cashier closed successfully"); 
                        hideAuthPopup();
                    }).catch(error => {
                        alert("Error closing cashier: " + error.message);
                    });
                }
            } catch (error) {
                // Authentication failed
                loading.style.display = "none";
                errorMessage.textContent = error.message;
                errorMessage.style.display = "block";
                document.getElementById("popupSubmit").disabled = false;
                console.error("Authentication error:", error);
            }
        });

        // Close popup when clicking outside
        document.getElementById("authPopup").addEventListener("click", function(e) {
            if (e.target === this) {
                hideAuthPopup();
            }
        });

        // Check for existing user session on page load
        window.addEventListener('load', function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                console.log('Current user:', savedUser);
            }
            
            // Debug: Check if users are loaded
            if (typeof users !== 'undefined') {
                console.log('Users loaded successfully:', users.map(u => u.username));
            } else {
                console.error('Users not loaded. Check user.js file.');
            }
        });
    </script>
</body>
</html>
